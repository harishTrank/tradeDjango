{% include "components/new-tab/user-header.html" %}
{% load static %}{% block newtab %}


<div class="tab-content" id="trademargin">
  <div class="flex">
    <div class="trade-download">
      <div style="transform: rotate(90deg); padding-left: 10px">
        <p id="tradeMarginFilterId">Filter</p>
      </div>
      <span>
        <a href=""><i class="fa-solid fa-file-cs"></i></a>
      </span>
    </div>
    <div class="trades-side">
      <div class="trade-top">
        <div class="flex space-bw">
          <div>
            <p>Filter</p>
          </div>
          <div class="closeBtn">
            <i class="fa-solid fa-xmark"></i>
          </div>
        </div>
      </div>
      <div class="trade-btm">
        <div class="flex space-bw">
          <label for="">Exchange:</label>
          <select name="tradeMarginExchangeId" id="tradeMarginExchangeId" class="form_control flex">
            <option value="MCX">MCX</option>
            <option value="NSE">NSE</option>
            <option value="MINI">MINI</option>
          </select>
        </div>
        <div class="flex space-bw">
          <label for="">Margin Type:</label>
          <select name="" id="" class="form_control">
            <option value="">Percentage</option>
            <option value="">Amount</option>
          </select>
        </div>

        <div class="flex space-bw">
          <label for="">Price</label>
          <input type="number" class="form_control" />
        </div>
        <div style="display: flex">
          <input
            type="submit"
            value="Apply"
            class="form-btn mr"
            style="border: 1px solid white"
            id="applyFilterId"
          />
          <input
            type="submit"
            value="Update"
            class="cancel-btn"
            style="border: 1px solid white"
          />
        </div>
        <button
          style="
            width: 100%;
            color: white;
            background-color: rgb(89, 89, 229);
            border: 1px solid white;
            padding: 4px;"
        >
          Update to All Users
        </button>
      </div>
    </div>
    <div class="trades-body user-table">
      <div class="pos-relate">
        <table style="width: 100%">
          <tr>
            <th><input id="tradeCheckBoxId" type="checkbox" /></th>
            <th>Exchange</th>
            <th>Script</th>
            <th>Expiry Date</th>
            <th>Trade Margin</th>
            <th>Description</th>
            <th>Updated Date</th>
          </tr>

          <tbody id="tradeMarginId">

          </tbody>
         
        </table>
      </div>
    </div>
  </div>
</div>
<script>

  $('.closeBtn').click(function () {
    $(".trades-side").hide();
    $(".trades-body").css("width", "96%");
});

$('#tradeMarginFilterId').click(function () {
  $(".trades-side").show();
  $(".trades-body").css("width", "67%");
});


  $("#tradeCheckBoxId").click(function(){
    $('input:checkbox').not(this).prop('checked', this.checked);
});

  const extractDate = (text) => {
    const parts = text.split('_');
    if (parts.length >= 3) {
      const months = {
        'JAN': 'JAN', 'FEB': 'FEB', 'MAR': 'MAR', 'APR': 'APR', 'MAY': 'MAY', 'JUN': 'JUN',
        'JUL': 'JUL', 'AUG': 'AUG', 'SEP': 'SEP', 'OCT': 'OCT', 'NOV': 'NOV', 'DEC': 'DEC'
      };
  
      const day = parts[2].substring(0, 2);
      const monthAbbreviation = parts[2].substring(2, 5);
      const year = parts[2].substring(5);
  
      const month = months[monthAbbreviation];
      if (!month) return '-'; // Invalid month abbreviation
  
      const formattedDate = `${day}-${month}-${year}`;
      return formattedDate;
    }
    return '-';
  };

  const miniList = [
  /ZINCMINI/,
  /SILVERM/,
  /NATGASMINI/,
  /LEADMINI/,
  /GOLDM/,
  /COPPERM/,
  /ALUMINIUM/,
  /CRUDEOILM/,
]


  const apiCallTradeMargin = (exchange = "") => {
    if (exchange !== "") {
        $('#updateBtnId').prop('disabled', false);
    }
    $.ajax({
      type: "GET",
      url: `${BASE_URL}/api/tradeCoin?coinType=${exchange}`,
      success: function (data) {
        console.log(data); 
        $("#tradeMarginId").empty();
        data.response.map(item => {
            const currentExchange = miniList.find(itemFind => item.InstrumentIdentifier.match(itemFind)) ? "MINI" : item.Exchange
            const expiryDate = extractDate(item.InstrumentIdentifier); // Extract date

          $("#tradeMarginId").append(`
            <tr>
            <td><input type="checkbox" /></td>
              <td>${currentExchange}</td>
              <td>${item.InstrumentIdentifier}</td>
              <td>${expiryDate}</td>
              <td>1000</td>
              <td>${item.Exchange !== "NSE" ? item.InstrumentIdentifier.replaceAll("_", " ").slice(0, -1) : item.InstrumentIdentifier}</td>
              <td></td>
            </tr>
          `);
        });
      },
      error: function (xhr, status, error) {
        console.error('Error:', error);
      }
    });
  }

  $("#applyFilterId").click(() => {
    apiCallTradeMargin($("#tradeMarginExchangeId").val())
  })

  apiCallTradeMargin();

</script>
{% endblock newtab %}

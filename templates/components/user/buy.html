<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
       a:active {
         color: blue;
       }

       #buyWatchId {
         display: none;
       }

       .change-pass {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background: rgba(0, 0, 0, 0.5);
       }

       * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
       }
       .spaceclass {
         justify-content: space-evenly;
       }
       .flex {
         display: flex;
         flex-wrap: wrap;
       }
       .space-bw {
         justify-content: space-between;
       }
       .align-center {
         align-items: center;
       }
       .text-center {
         text-align: center;
       }
       .white-back {
         background: #fff;
         box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.1);
       }

       .create-profile {
         position: fixed;
         top: 0;
         left: 0;
         background: rgba(0, 0, 0, 0.5);
         width: 100%;
         height: 100%;
         z-index: 99;
       }
       .create-profile-inside {
         width: 80%;
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         z-index: 999;
         background: #e7e7e7;
         border-radius: 10px;
       }
       .admin-right i {
         margin-right: 8px;
         color: #0000FF;
         font-size: 10px;
         margin-top: 2px;
       }
       .top-body {
         background-color: #fff;
         padding: 8px;
         border-top-left-radius: 10px;
         border-top-right-radius: 10px;
       }
       .middle-body {
         padding: 15px;
       }
       .inner-middle-body {
         padding: 6px;
         border:none;


       }

       .save-cancel-btn {
         padding: 0px 75px;
       }
       .save-cancel-btn button:first-child {
         background-color: #008000;
         padding: 2px 10px;
         color: #fff;
         border: none;
       }
       .save-cancel-btn button:last-child {
         background-color: #221b1b;
         padding: 10px 20px;
         color: #fff;
         border: none;
       }
       .input-tags input {
         padding: 3px 6px;
         margin: 0px 6px;
         border: 1px solid black;
         background-color: #e7e7e7;
         border-radius: 4px;
       }
       .mrg-tb {
         margin: 8px 0px;
       }
       .pop-up-text p {
         font-size: 16px;
         font-weight: 600;
       }
       .limit p {
         margin-right: 25px;
       }
       .limit div:first-child {
         margin-right: 20px;
       }
       .clients p {
         margin-right: 8px;
       }
       .btns button:first-child {
         margin-right: 10px;
         padding: 10px 20px;
       }
       .client-name{
           display: flex;
           flex-direction: column;
           width: 19%;


       }
       .client-name select,input{
           {% comment %} margin-top: 5px; {% endcomment %}
           padding:2px;
           border: 1px solid #000;
       }
       .submit-btn{

           display: flex;
           flex-direction: column;
           width: 19%;

       }
      .submit-btn input{
       {% comment %} margin-top: 5px; {% endcomment %}
       padding: 4px;
       background: #008000;
           color: #fff;
           border: 1px solid #fff;
           font-weight: bold;
      }
      .cancel-finalbtn input{
       margin-top: 5px;
       padding: 4px;
       background: #000;
           color: #fff;
           border: 1px solid #fff;
           font-weight: bold;
      }
      .cancel-finalbtn{
       display: flex;
           flex-direction: column;
           width: 19%;
      }
      .client-name label{
       color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="create-profile" id="buyWatchId">
      <div class="change-pass">
        <div class="create-profile-inside">
          <div class="top-body flex align-center space-bw align-center">
            <div class="flex admin-right">
              <p>Buy Orders</p>
            </div>
            <div id="buysellId">
              <i class="fa-solid fa-x closeAccountLimit"></i>
            </div>
          </div>
          <div class="middle-body" style="background-color: #0000ff">
            <div class="inner-middle-body flex space-bw">
              <div class="client-name">
                <label for="">Client Name</label>
                <select id="clientnameId">
                  <option value="">Select</option>
                </select>
              </div>
              <div class="client-name">
                <label for="orderType">Order Type</label>
                <select id="orderTypeId" onChange="orderTypehandler()">
                  <option value="Market">Market</option>
                  <option value="Limit">Limit</option>
                  <option value="StopLoss">Stop Loss</option>
                </select>
              </div>
              <div class="client-name">
                <label for="">Quantity</label>
                <input id="quantitybuyId" type="text" />
              </div>
              <div class="client-name">
                <label for="sellPrice">Sell Price</label>
                <input
                  type="number"
                  id="sellPrice"
                  disabled
                  class="sellPrices"
                />
              </div>
              <div class="submit-btn">
                <label for="" style="color: #0000ff">Submit</label>
                <input id="buysubBtnId" type="submit" />
              </div>
            </div>
            <div class="inner-middle-body flex space-bw">
              <div class="client-name">
                <label for="">Exchange</label>
                <select id="symbleExchange">
                  <option value="">Select</option>
                  {% for i in coin_type %}
                    <option value="{{i}}">{{i}}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="client-name">
                <label for="">Symbol</label>
                <select
                  id="symbolId"
                >
                  <option value="">Select</option>
                </select>
              </div>
              <div class="client-name">
                <label for="">LotSize</label>
                <input id="lotsizebuyID" type="text" class="QuotationLot" disabled />
              </div>
              <div class="client-name">
                <label for="">Remark</label>
                <input type="text" />
              </div>
              <div class="cancel-finalbtn">
                <label for="" style="color: #0000ff">Cancel</label>
                <input type="submit" value="Cancel" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const watchbuyhandler = () => {
        $("#buyWatchId").css("display", "block");
        toggleOption = "buy";
        $('.action_dropdown').toggle();
        $("#watchPopUpId").css("display", "none");
        socket.emit("getOneData", {"identifier": JSON.parse(sessionStorage.getItem("currentCoin"))?.InstrumentIdentifier });
        socket.on("getOneDataSend", (data) => {
            if (toggleOption === 'buy') { // Added parentheses around the condition
                $(".QuotationLot").val(data?.QuotationLot);
            } else {
                $("#lotsizesellID").val(data?.QuotationLot);
            }
            if ($("#orderTypeId").val() == "Market") { // Changed single equal sign to double equal signs for comparison
                $("#sellPrice").val(data.SellPrice);
            }
        });
    }
    
    
      $("#symbleExchange").change((event) => {
        let symbolKey = event.target.value;
        axios.get(`${BASE_URL}/api/tradeCoin?coinType=${symbolKey}`)
          .then(res => {
            $("#symbolId").empty();
            $("#symbolId").html("<option>Select</option>");
            res.data.response.map(item => 
              $("#symbolId").append(`<option value=${item.InstrumentIdentifier}>${item.InstrumentIdentifier}</option>`));
          })
          .catch(err => {
            console.log("err", err);
          });
      });

      $("#symbolId #buysymbolId").change((event) => {
        socket.emit("getOneDataOff");
        socket.emit("getOneData", {"identifier": event.target.value });
        socket.on("getOneDataSend", (data) => {
            if (toggleOption === 'buy') {
                $(".QuotationLot").val(data?.QuotationLot);
                $("#sellPrice").val(data.SellPrice);
            } else {
                $("#lotsizesellID").val(data?.QuotationLot);
                $("#buyPrice").val(data.BuyPrice);
            }
            if ($("#orderTypeId").val() === "Market") { 
                $("#sellPrice").val(data.SellPrice);
            }
        });
    });
    
      // ------------------------
    
      $(document).ready(function() {
        $('#orderTypeId').change(function() {
          var selectedOption = $(this).val();
          if (selectedOption === "Market") {
            $('#sellPrice').prop('disabled', true);
          } else {
            $('#sellPrice').prop('disabled', false);
          }
        });
      });
    
      $("#buysellId").click(() =>
        $("#buyWatchId").css("display", "none")
      );
    
      function toggleMenuOption(itemString) {
        const item = JSON.parse(unescape(itemString));
        sessionStorage.setItem("currentCoin", JSON.stringify(item));
        $("#watchPopUpId").css("display", "block");

        if (toggleOption === 'buy') {
          $("#symbleExchange").val(item.Exchange);
        }else{
          $("#buyexchangeId").val(item.Exchange);
        }
        axios.get(`${BASE_URL}/api/tradeCoin?coinType=${item.Exchange}`)
          .then(res => {
            if (toggleOption === 'buy') {
              $("#symbolId").empty();
              $("#symbolId").html("<option>Select</option>");
              res.data.response.map(item => 
                $("#symbolId").append(`<option value=${item.InstrumentIdentifier}>${item.InstrumentIdentifier}</option>`));
              if (item.InstrumentIdentifier) {
                $("#symbolId").val(item.InstrumentIdentifier);
              }
            }else{
              $("#buysymbolId").empty();
              $("#buysymbolId").html("<option>Select</option>");
              res.data.response.map(item => 
                $("#buysymbolId").append(`<option value=${item.InstrumentIdentifier}>${item.InstrumentIdentifier}</option>`));
              if (item.InstrumentIdentifier) {
                $("#buysymbolId").val(item.InstrumentIdentifier);
              }
            }
          })
          .catch(err => {
            console.log("err", err);
          });
        $('.action_dropdown').toggle();
      }

      const handleBuySubmission = () => {
        const data = JSON.parse(sessionStorage.getItem("currentCoin"));
        const currentButton = $("#orderTypeId").val().toUpperCase();
        const currentPrice = Number($("#sellPrice").val());
        const actionType = "BUY"; 
    
        if (currentButton === "STOPLOSS") { 
            if (actionType === "BUY" && currentPrice > data.BuyPrice) {
                toastMixin.fire({
                    animation: true,
                    title: "Price key must be lower than the buy price.",
                    icon: "error",
                });
                return;
            }
        }
    
        const body = {
            type: "WEB",
            action: "BUY",
            userId: $("#clientnameId").val(),
            quantity: parseInt($("#quantitybuyId").val()),
            lot_size: parseInt($("#lotsizebuyID").val()),
            is_cancel: false,
            ex_change: $("#symbleExchange").val(),
            price: parseInt($("#sellPrice").val()),
            coin_name: $("#symbolId").val(),
            identifer: $("#symbolId").val(),
            order_method: "Web " + $("#orderTypeId").val(), 
            ip_address: "",
            stop_loss: parseInt($("#sellPrice").val()),
            high: data.High,
            low: data.Low,
            is_pending: currentButton === "LIMIT", 
            trade_type: currentButton,
        };
    
        axios.post(`{% url "buy-sell-coin" %}`, body, { headers: { "X-CSRFToken": "{{ csrf_token }}" } })
            .then(function (response) {
                toastMixin.fire({
                    animation: true,
                    title: response.data.message,
                    icon: "success",
                });
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            })
            .catch(err => {
                console.log("err", err);
                toastMixin.fire({
                    animation: true,
                    title: err.response.data.message,
                    icon: "error",
                });
            });
    };
    $("#buysubBtnId").click(handleBuySubmission);
    

    {% if request.user.user_type != "Client" %}
        axios.get(`{% url "get-client-api" %}`, {headers: { "X-CSRFToken": "{{ csrf_token }}" }})
        .then(res => {
            res.data.user_client.map(item => {
                $("#clientnameId").append(`<option value=${item.id}>${item.user_name}</option>`)
            })
        }).catch(err=> console.log("err", err))
    {% endif %}

    </script>
  </body>
</html>

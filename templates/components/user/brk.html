{% include "components/new-tab/user-header.html" %}
{% load static %}{% block newtab %}

<div class="tab-content" id="brk">
     <div class="tab-head">
      <li onClick="trunOverWise()" class="active" data-id="chart">
        TURNOVER WISE SETTING
      </li>
      <li onClick="symbolWise()" data-id="table">SYMBOL WISE SETTING</li>
    </div>
    <div class="brk-tab-wrapper flex">
        <div class="brk-tab-content" id="turnover-wise">
            <div class="flex">
                <div class="trade-download">
                    <div style="transform: rotate(90deg);padding-left: 10px;">
                        <p id="brkFilterID">Filter</p>
                    </div>
                    <span>
                      <a href=""><i class="fa-solid fa-file-csv"></i></a>
                    </span>
                </div>
                <div class="trades-side">
                    <div class="trade-top">
                        <div class="flex space-bw">
                            <div>
                                <p>Filter</p>
                            </div>
                            <div class="closeBtn">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                        </div>
                    </div>
                    <div class="trade-btm">
                   
                        <div class="flex space-bw">
                            <label for="" >Exchange:</label>
                            <select name="" class="form_control flex" id="brkFilterId" onchange="exchangeOnchange(this.value)" >
                              {% for i in exchange %}
                                <option value="{{i.symbol_name}}">{{i.symbol_name}}</option>
                              {% endfor %}
                            </select>
                        </div>
                        <div class="flex space-bw">
                            <label for="">Brk<br>Rs 1/Lac:</label>
                            <input id="priceValueId" type="number" value="1" class="form_control">
                        </div>

                        <div style="display: flex;" >
                            <input id="brkSearchID" type="submit" value="Apply" class="form-btn mr" style="border: 1px solid white;">
                            <input id="updateBtnId" onClick="updateBtnHandler(event)" type="submit" value="Update" class="cancel-btn" style="border: 1px solid white;">
                        </div>
                    </div>
                </div>    
            </div>
        </div>

        <div id="turnoverWiseID" class="trades-body user-table" style="position:absolute;right:0;">
            <table style="width: 100%;">
              <tr>
                <th><input id="brkCheckAllId" type="checkbox"></th>
                    <th>Exchange</th>
                    <th>Script</th>
                    <th>Turnover Wise Brk (Rs.per1/Lac)</th>
              </tr>
               
              <tbody id="brktableId">
               
              </tbody>
            </table>
        </div>

        <div id="symbolWiseId" class="trades-body user-table" style="position:absolute;right:0; display: none">
          <table style="width: 100%;">
            <tr>
              <th><input id="symbolWisecheckbox" type="checkbox"></th>
                  <th>Exchange</th>
                  <th>Script</th>
                  <th>Lot Size</th>
                  <th>Brk (Rs.)</th>
            </tr>
             
            <tbody id="symbolWiseTable">
            
            </tbody>
          </table>
      </div>

    </div>
</div>


<script>

  function trunOverWise() {
    $("#turnoverWiseID").css('display','block');
    $("#symbolWiseId").css('display','none');
    $(".tab-head li").removeClass("active"); 
    $(".tab-head li[data-id='chart']").addClass("active");
  }
  function symbolWise() {
    $("#turnoverWiseID").css('display','none');
    $("#symbolWiseId").css('display','block');
    $(".tab-head li").removeClass("active");
    $(".tab-head li[data-id='table']").addClass("active"); 
  }

    $("#brkCheckAllId").click(function(){
        $('input:checkbox').not(this).prop('checked', this.checked);
    });

    $("#symbolWisecheckbox").click(function(){
      $('input:checkbox').not(this).prop('checked', this.checked);
  });
    
    $('#brkFilterID').click(function () {
        $(".trades-side").show();
      });

    $("#checkAll").click(function(){
      $('input:checkbox').not(this).prop('checked', this.checked);
  });
  
    $('.closeBtn').click(function () {
      $(".trades-side").hide();
      $(".trades-body").css("width", "95%");
  });
  
  $('#openFilerId').click(function () {
    $(".trades-side").show();
  });
  

  let exchangeOnchange = (selectedValue) => {
    axios.get(`{% url 'brk-setting-api' %}?user_id={{ user.id }}&ex_change=${selectedValue}`, {
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    })
    .then(response => {
        console.log("Response:", response.data); 
        $("#brktableId").empty();
        $("#symbolWiseTable").empty();
        response.data.response.map(item => {
            $("#brktableId").append(`
                <tr>
                  <td><input class="brkCheckAllClass" value="${item.id}" type="checkbox"></td>
                    <td>${item.ex_change}</td>
                    <td>${item.identifier}</td>
                    <td>${item.turnover_brk}</td>
                </tr>
            `);

            $("#symbolWiseTable").append(`
                <tr>
                  <td><input class="brkCheckAllClass" value="${item.id}" type="checkbox"></td>
                    <td>${item.ex_change}</td>
                    <td>${item.identifier}</td>
                    <td>${item.lot_size}</td>
                    <td>${item.lot_brk}</td>
                </tr>
            `);
        });
    })
    .catch(err => console.log("err", err));
}

exchangeOnchange("{{first}}"); 


let checkedIds = new Set(); 

$("#brkCheckAllId").click(function() {
  $('#brktableId input:checkbox').prop('checked', this.checked);
  checkedIds.clear(); 
  
  if ($(this).is(':checked')) {
    $('.brkCheckAllClass').each(function() {
      checkedIds.add($(this).val());
    });
    console.log('All checked item IDs:', Array.from(checkedIds)); // Convert Set to Array for logging
  }
});

$(document).on('change', '.brkCheckAllClass', function() {
  const itemId = $(this).val();

  if ($(this).is(':checked')) {
    checkedIds.add(itemId); 
  } else {
    checkedIds.delete(itemId); 
  }
  console.log('Selected item IDs:', Array.from(checkedIds)); 
});




let symbolsIds = new Set(); 

$("#symbolWisecheckbox").click(function() {
  $('#symbolWiseTable input:checkbox').prop('checked', this.checked);
  symbolsIds.clear(); 
  
  if ($(this).is(':checked')) {
    $('.brkCheckAllClass').each(function() {
      symbolsIds.add($(this).val());
    });
    console.log('All checked item IDs:', Array.from(symbolsIds)); // Convert Set to Array for logging
  }
});

$(document).on('change', '.brkCheckAllClass', function() {
  const itemId = $(this).val();

  if ($(this).is(':checked')) {
    symbolsIds.add(itemId); 
  } else {
    symbolsIds.delete(itemId); 
  }
  console.log('Selected item IDs:', Array.from(symbolsIds)); 
});
  
  const updateBtnHandler = (event) => {
    event.preventDefault();
  
    let brkType = "TURNOVER WISE"; 
    if ($("#symbolWiseId").css('display') === 'block') {
      brkType = "";
    }
    const amount = $("#priceValueId").val();
  
    const body = {
      brk_type: brkType,
      amount: amount,
      object_list: checkedIds 
    };
  
    axios
      .post(
        '{% url "brk-setting-api" %}',
        body,
        { headers: { "X-CSRFToken": "{{ csrf_token }}" } }
      )
      .then((response) => {
        console.log("Response:", response.data);
        toastMixin.fire({
          animation:true,
          title:response.data.message,
          icon: "success",
        });
        setTimeout(()=>
        window.location.reload(),2800
        )
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  };
  
  
  </script>

{% endblock newtab %}

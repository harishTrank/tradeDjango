{% extends "index.html" %} {% block content %}


<div class="tab-content" id="m2mpnl">
    <div class="flex">
        <div class="trade-download">
            <div style="transform: rotate(90deg);padding-left: 10px;">
                <p>Filter</p>
            </div>
            {% comment %} <span>
                <a href=""><i class="fa-solid fa-file-csv"></i></a>
            </span> {% endcomment %}
        </div>
        <div class="trades-side">
            <div class="trade-top">
                <div class="flex space-bw">
                    <div>
                        <p>Filter</p>
                    </div>
                    <div class="closeBtn">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                </div>
            </div>
            <form method="get">
                {% csrf_token %}
            <div class="trade-btm">
                <div>
                    <label for="">Username:</label>
                    <select  id="m2mUserNameId">
                        <option value="">All Users</option>
                        {% for i in user_obj %}
                            <option value="{{i.user_name}}">{{i.user_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for=""></label>
                    <button type="button" id="m2mBtnId" class="form-btn">Apply</button>
                    <a href="{% url 'Admin:m2m-profit-and-loss' %}" style="color:#fff !important;padding: 2px 10px; cursor:pointer;" class="cancel-btn">Clear</a>
                </div>
            </div>
        </form>
        </div>
        <div class="trades-body user-table">
            <table style="width: 100%;">
                <tr>
                    <th>User</th>
                    <th>User Type</th>
                    <th>Profit / Loss</th>
                    <th>PL Share(%)</th>
                    <th>PL Share Amount</th>
                </tr>
                <tbody id="m2mPnLId">
                    <tr>
                        <td>User</td>
                        <td>User Type</td>
                        <td>Profit / Loss</td>
                        <td>PL Share(%)</td>
                        <td>PL Share Amount</td>
                    </tr>
                </table>
            </table>
        </div>
    </div>
</div>

<script>

    const m2mProfitHandler = (user_ ,user_id = "{{user.id}}") =>{

        let m2mListUserWise = [];
        axios.get(`{% url "weekly-admin-api" %}?user_id=${user_id}&user_name=${user_name}`, {headers: { "X-CSRFToken": "{{ csrf_token }}" }})
        .then(res => {
            console.log("res ==", res);
            $("#m2mPnLId").empty();
            if (res?.data?.result) {
                  axios
                    .post(`${BASE_URL}/api/tradeCoin/weekly`, {
                      identifiers: res?.data?.result?.map(
                        (obj) => obj.identifer
                      ),
                    })
                    .then((res1) => {
                      res?.data?.result.map((mapItem) => {
                          const currentLiveData = res1.data?.response?.find(
                            (liveData) =>
                              liveData?.InstrumentIdentifier === mapItem?.identifer
                          );
                          const currentP_L =
                            mapItem?.total_quantity > 0
                              ? (currentLiveData?.BuyPrice - mapItem?.avg_buy_price) *
                                mapItem?.total_quantity *
                                currentLiveData?.QuotationLot
                              : (mapItem?.avg_sell_price - currentLiveData?.SellPrice) *
                                Math.abs(mapItem?.total_quantity) *
                                currentLiveData?.QuotationLot;
    
                            m2mListUserWise = [
                            ...(m2mListUserWise || []),
                            {
                              user_id: mapItem?.buy_sell_user__id,
                              m2mTotal: currentP_L,
                            },
                          ];
                      });
                    })
            }
    
            setTimeout(() => {
                res.data.release_p_and_l.map(item => {
                    const filterUser = m2mListUserWise?.filter(obj => obj.user_id === item.user_summary__id)
                    const m2mFinal =  Number(
                        filterUser && filterUser.length === 0
                          ? 0
                          : filterUser.length === 1
                          ? filterUser?.[0]?.m2mTotal?.toFixed(2)
                          : filterUser?.reduce((a, b) => a?.m2mTotal || 0 + b?.m2mTotal || 0)
                      )?.toFixed(2);
                    $("#m2mPnLId").append(`
                        <tr>
                            <td>${item.user_summary__user_name}</td>
                            <td>${item.user_summary__user_type}</td>
                            <td style="color:${item.total_amount >=0 ? 'blue':'red'};">${item.total_amount.toFixed(2)}</td>
                            <td style="color:${m2mFinal >=0 ? 'blue':'red'};">${m2mFinal}</td> 
                            <td style="color: ${(Number(m2mFinal) + Number(item.total_amount)) >= 0 ? 'blue' : 'red'};">${(Number(m2mFinal) +Number(item.total_amount))?.toFixed(2)}</td>
                        </tr>
                    `);
                });
            }, 1000)
        })
        .catch(err => {
            console.log("err", err);
        });
    }
    m2mProfitHandler();

    $("#m2mBtnId").click(() => {
        m2mProfitHandler($("#m2mUserNameId").val());
      })
</script>

{% endblock content %}

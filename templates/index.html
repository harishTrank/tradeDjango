{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" />

    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

    <!-- CDN for toast message -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@10.10.1/dist/sweetalert2.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
      integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- chart js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src= 
"https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"> 
    </script> 
    <script src= 
"https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"> 
    </script> 
    <!-- chart js -->


  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

  <script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-pie.min.js"></script>

    <style>
      .page-tab {
        border-bottom: 1px solid #d3d3d3;
      }

      .page-tab li {
        display: inline-block;
        padding: 5px 15px;
        position: relative;
        margin-right: 5px;
        cursor: pointer;
        font-size: 15px;
      }

      .page-tab li i {
        margin-left: 5px;
        font-size: 12px;
      }

      .page-tab li.page-active {
        background: lightblue;
        color: #000;
      }
    </style>
  </head>
  <body>
    {% include "header.html" %} 
    
    {% if messages %} {% for message in messages %}
    {% if message.tags == "alert-success" %}
    <p id="idd1" hidden>{{ message }}</p>
    {% elif message.tags == "alert-danger" %}
    <p id="idd2" hidden>{{ message }}</p>
    {% elif message.tags == "alert-warning" %}
    <p id="idd3" hidden>{{ message }}</p>
    {% elif message.tags == "alert-info" %}
    <p id="idd4" hidden>{{ message }}</p>
    {% endif %} {% endfor %} {% endif %} 


    <div class="tab-wrapper">
      {% block content %} {% endblock content %}
      {% include "components/user/account-limit.html" %}
      {% include "components/user/admin-rights.html" %}
      {% include "components/user/market-trade-master.html" %}
    </div>
    {% include "components/password-popup.html" %}
    {% include "components/user/parent-limit-info.html" %}
    {% include "components/user/intraday-square-off.html" %}
    {% comment %} {% include "components/user/w-popup.html" %}
    {% include "components/user/buy.html" %} {% endcomment %}
    

  </body>
  <script>
    var toastMixin = Swal.mixin({
      toast: true,
      title: "General Title",
      animation: false,
      position: "top-right",
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener("mouseenter", Swal.stopTimer);
        toast.addEventListener("mouseleave", Swal.resumeTimer);
      },
    });
    var x = $("#idd1").text();
    if (x !== "") {
      toastMixin.fire({
        animation: true,
        title: x,
        icon: "success",
      });
    }
    var x = $("#idd2").text();
    if (x !== "") {
      toastMixin.fire({
        animation: true,
        title: x,
        icon: "error",
      });
    }

    var x = $("#idd3").text();
    if (x !== "") {
      toastMixin.fire({
        animation: true,
        title: x,
        icon: "warning",
      });
    }

    var x = $("#idd4").text();
    if (x !== "") {
      toastMixin.fire({
        animation: true,
        title: x,
        icon: "info",
      });
    }


    const accountLimit = () => {
      $("#accountLimitid").css("display", "block");
      $('.action_dropdown').toggle();
    }
    const adminRights = () => {
        $("#adminRightsId").css("display","block");
        $('.action_dropdown').toggle();
    }
    const tradeRights = () => {
      $("#tradeRightId").css("display", "block");
      $('.action_dropdown').toggle();
    }
    const toggleMenuOption = () => {
      $("#watchPopUpId").css("display", "block")
      $('.action_dropdown').toggle();
    }
    {% comment %} const watchBuyId = () => {
      $("#buyWatchId").css("display","block")
      $(".action_dropdown").toggle();
    } {% endcomment %}

    const parentLimitInfo = () =>{
      $("#parentLimitInfoId").css("display", "block")
      $('.action_dropdown').toggle();
      axios
      .get(
        `{% url "account-limit" %}?user_id=${$(
          "#current_selected_userId"
        ).val()}`,
        { headers: { "X-CSRFToken": "{{ csrf_token }}" } }
      )
      .then((res) => {
        $("#parentmasterlimit").text(res.data.master_limit);
        $("#parentclientlimit").text(res.data.client_limit);
        $("#parentmasterOccId").text(res.data.master_occupied);
        $("#parentmasterRemId").text(res.data.master_remaining);
        $("#parentclientOccId").text(res.data.client_occupied);
        $("#parentclientRemId").text(res.data.client_remaining);
        $("#parentmasterCreatedId").text(res.data.master_created);
        $("#parentclientCreatedId").text(res.data.client_created);
        console.log("parentLimitInfo ==", res);
      })
      .catch((err) => {
        console.log("err", err);
      });
    }

    const intradaySquare = () =>{
      $("#intradayId").css("display", "block")
      $('.action_dropdown').toggle();
     
    axios.get(`{% url "intraday-squareoff-check" %}?user_id=${$("#current_selected_userId").val()}`, {
      headers: {
          "X-CSRFToken": "{{ csrf_token }}"
      }
    })
    .then(response => {
        console.log("res ==", response);
        $("#mcxId").prop("checked", response.data.data.mcx);
        $("#nseId").prop("checked", response.data.data.nse);
        $("#miniId").prop("checked", response.data.data.mini);
    })
    .catch(error => {
        console.log("err", error);
    });
  }


  const intradayHandler = (event) => {
    event.preventDefault();
  
    const selectedUserId = $("#current_selected_userId").val();
  
    axios
      .post(
        `{% url "intraday-squareoff-check" %}?user_id=${selectedUserId}`,
        {
          nse: $("#nseId").prop("checked"),
          mcx: $("#mcxId").prop("checked"),
          mini: $("#miniId").prop("checked"),
        },
        { headers: { "X-CSRFToken": "{{ csrf_token }}" } }
      )
      .then((response) => {
        console.log("Response:", response.data);
        toastMixin.fire({
          animation: true,
          title: response.data.message,
          icon: "success",
        });
        setTimeout(() => window.location.reload(), 2800);
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  };

  
  </script>
</html>

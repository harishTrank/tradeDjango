{% extends "index.html" %} {% block content %}

<div class="tab-content" id="trademargin">
  <div class="flex">
    <div class="trade-download">
      <div style="transform: rotate(90deg); padding-left: 10px; cursor:pointer;">
        <p id="tradeMarginFilterId">Filter</p>
      </div>
      {% comment %} <span>
        <a href=""><i class="fa-solid fa-file-csv"></i></a>
      </span> {% endcomment %}
    </div>
    <div class="trades-side">
      <div class="trade-top">
        <div class="flex space-bw">
          <div>
            <p>Filter</p>
          </div>
          <div class="closeBtn">
            <i class="fa-solid fa-xmark"></i>
          </div>
        </div>
      </div>
      <form method="get">
        {% csrf_token %}
      <div class="trade-btm">
        <div class="flex space-bw">
          <label for="">Exchange:</label>
          <select name="exchange" id="tradesMarginExchangeId" onchange="tradeExchangeOnchange(this.value)" class="form_control flex">
            {% for i in exchange_obj %}
              <option value="{{i.symbol_name}}">{{i.symbol_name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex space-bw">
          <label for="">Margin Type:</label>
          <select name="margin_type" id="marginTypeDropdownId" class="form_control">
            <option value="">Percentage</option>
            <option value="">Amount</option>
          </select>
        </div>

        <div class="flex space-bw">
          <label for="">Price</label>
          <input id="tradepriceValueId" value="1" type="number" name="price" class="form_control" />
        </div>
        <div style="display: flex">
          <button
          type="button"
          value="Apply"
          class="form-btn mr"
          style="border: 1px solid white"
          id="applyFilterId"
          onclick="updateTradeMarginValue()"
        >
          Apply
        </button>
          <button
            type="submit"
            value="Update"
            class="cancel-btn"
            style="border: 1px solid white"
            onClick="tradeMarginOnclick(event)"
            >Update
          </button>
        </div>
        <button
          style="
            width: 100%;
            color: white;
            background-color: rgb(89, 89, 229);
            border: 1px solid white;
            padding: 4px;"
            onClick="updateAllUsers(event)"
        >
          Update to All Users
        </button>
      </div>
    </form>
    </div>
    <div class="trades-body user-table">
      <div class="pos-relate">
        <table style="width: 100%">
          <tr>
            <th><input id="tradeCheckBoxId" type="checkbox" /></th>
            <th>Exchange</th>
            <th>Script</th>
            {% comment %} <th>Expiry Date</th> {% endcomment %}
            <th>Trade Margin</th>
            {% comment %} <th>Description</th> {% endcomment %}
            <th>Updated Date</th>
          </tr>
          <tbody id="radeMarginTableId">
          
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  
  $('.closeBtn').click(function () {
    $(".trades-side").hide();
    $(".trades-body").css("width", "97%");
});

$('#tradeMarginFilterId').click(function () {
  $(".trades-side").show();
  $(".trades-body").css("width", "79%");
});

$("#tradeCheckBoxId").click(function(){
  $('input:checkbox').not(this).prop('checked', this.checked);
});


$('#tradesMarginExchangeId').on('change', function() {
  var selectedValue = $(this).val();
  var marginTypeDropdown = $('#marginTypeDropdownId');
  if (selectedValue === 'NSE') {
    marginTypeDropdown.empty(); 
    marginTypeDropdown.append('<option value="">Percentage</option>');
  } else {
    marginTypeDropdown.empty();
    marginTypeDropdown.append('<option value="">Amount</option>'); 
  }
});

function updateTradeMarginValue() {
  const inputValue = $("#tradepriceValueId").val();
  const checkedCheckboxes = $('#radeMarginTableId input:checkbox:checked');
  if (checkedCheckboxes.length === 0) {
    alert('Please select at least one checkbox.');
    return;
  }
  checkedCheckboxes.each(function() {
    const row = $(this).closest('tr');
    const cell = row.find('.tradeMarginValueCell');
    cell.text(inputValue);
  });
}


let tradeExchangeOnchange = (selectedValue) => {
  axios.get(`{% url 'trademargin-setting-api' %}?user_id={{ user.id }}&ex_change=${selectedValue}`, {
      headers: { "X-CSRFToken": "{{ csrf_token }}" }
  })
  .then(response => {
      console.log("Response:", response.data); 
      $("#radeMarginTableId").empty();
      response.data.response.map(item => {
        let tradeMarginValue = selectedValue === 'NSE' ? item.trademargin_percentage : item.trademargin_amount;
        $("#radeMarginTableId").append(`
                <tr>
                  <td><input class="brkCheckAllClass" value="${item.id}" type="checkbox"></td>
                    <td>${item.ex_change}</td>
                    <td>${item.identifier}</td>
                    <td class="tradeMarginValueCell">${tradeMarginValue}</td>
                    <td>${item.updated_at}</td>
                </tr>
            `);
      });
  })
  .catch(err => console.log("err", err));
}

tradeExchangeOnchange("{{first}}");


const tradevalidateCheckbox = () => {
  const checkboxes = $("#radeMarginTableId input:checkbox:checked");

  if (checkboxes.length === 0) {
    alert("Please select at least one checkbox.");
    return false;
  }
  return true;
};


let tradeMarginIds = []; 
$("#tradeCheckBoxId").click(function() {
  $('#radeMarginTableId input:checkbox').prop('checked', this.checked);

  if ($(this).is(':checked')) {
    tradeMarginIds = [];
    $('.brkCheckAllClass').each(function() {
      if (!(tradeMarginIds.includes($(this).val()))) {
        tradeMarginIds.push($(this).val());
      }
    });
    console.log('All checked item IDs:', tradeMarginIds);
  } else {
    tradeMarginIds = []
  }
});

$(document).on('change', '.brkCheckAllClass', function() {
  if ($(this).is(':checked')) {
    tradeMarginIds.push($(this).val()); 
    console.log('Selected item IDs:', tradeMarginIds);
  } else {
    if (!$("#radeMarginTableId").is(':checked')) {
      tradeMarginIds = [];
      console.log('All items unchecked. Emptying tradeMarginIds array.');
    } else {
      const index = tradeMarginIds.indexOf($(this).val());
      if (index !== -1) {
        tradeMarginIds.splice(index, 1); 
      }
      console.log('Selected item IDs:', tradeMarginIds);
    }
  }
});

const tradeMarginOnclick = (event) => {
  event.preventDefault();
  if (!tradevalidateCheckbox()) {
    return;
  }
  const body = {
    exchange: $("#tradesMarginExchangeId").val(),
    amount: $("#tradepriceValueId").val(),
    object_list: tradeMarginIds 
  };

  axios
    .post(
      '{% url "trademargin-setting-api" %}',
      body,
      { headers: { "X-CSRFToken": "{{ csrf_token }}" } }
    )
    .then((response) => {
      console.log("Response:", response.data);
      toastMixin.fire({
        animation:true,
        title:response.data.message,
        icon: "success",
      });
      setTimeout(()=>
      window.location.reload(),2800
      )
    })
    .catch((error) => {
      console.error("Error:", error);
    });
};



const updateAllUsers = (event) => {
  event.preventDefault();
  if (!tradevalidateCheckbox()) {
    return;
  }

  const identifierList = [];
  $('.brkCheckAllClass').each(function() {
    if ($(this).is(':checked')) {
      
      const identifier = $(this).closest('tr').find('td:eq(2)').text(); 
      identifierList.push(identifier);
    }
  });
  const body = {
    exchange: $("#tradesMarginExchangeId").val(),
    amount: $("#tradepriceValueId").val(),
    identifier_list: identifierList,
    user_id : "{{user.id}}"
  };

  axios
    .post(
      '{% url "trademargin-all-setting-api" %}',
      body,
      { headers: { "X-CSRFToken": "{{ csrf_token }}" } }
    )
    .then((response) => {
      console.log("Response:", response.data);
      toastMixin.fire({
        animation:true,
        title:response.data.message,
        icon: "success",
      });
      setTimeout(()=>
      window.location.reload(),2800
      )
    })
    .catch((error) => {
      console.error("Error:", error);
    });
};

</script>

{% endblock content %}

{% extends "index.html" %} {% block content %}
<div class="tab-content" id="orders">
  <div class="flex">
    <div class="trade-download">
      <div style="transform: rotate(90deg);padding-left: 10px; cursor:pointer;">
          <p id="openFilerId">Filter</p>
      </div>
      {% comment %} <span>
          <a href=""><i class="fa-solid fa-file-csv"></i></a>
      </span> {% endcomment %}
  </div>
      <div class="trades-side" style="position: fixed;">
          <div class="trade-top">
              <div class="flex space-bw">
                  <div>
                      <p>Filter</p>
                  </div>
                  <div class="closeBtn">
                      <i class="fa-solid fa-xmark"></i>
                  </div>
              </div>
          </div>
          <div class="trade-btm">
            <div>
              <label for="">Exchange:</label>
              <select name="exchangeFilter" id="exchangeFilter">
                  <option value="">All exchange</option>
                  <option value="MCX">MCX</option>
                  <option value="NSE">NSE</option>
                  <option value="MINI">MINI</option>
              </select>
          </div>
              <div>
                  <label for=""></label>
                  <input type="submit" value="Search" class="form-btn" id="serachBtnId">
                  <input onClick="refreshPage()" type="submit" value="Clear" class="cancel-btn">
              </div>
          </div>
      </div>
      <div class="trades-body user-table" style="position:absolute;right:0;">
          <table style="width: 100%;">
            <tr>
              <th><input id="checkAll" type="checkbox" /></th>
              <th>Exchange</th>
              <th>Script</th>
              <th>Expiry Date</th>
              <th>Description</th>
              <th>Trade Attribute</th>
              <th>Allow Trade</th>
            </tr>
            <tbody id="userScriptId">

            </tbody>
          </table>
      </div>
  </div>
</div>

<script>
  function refreshPage(){
    window.location.reload();
} 

  $("#checkAll").click(function(){
    $('input:checkbox').not(this).prop('checked', this.checked);
 });

  $('.closeBtn').click(function () {
    $(".trades-side").hide();
    $(".trades-body").css("width", "98%");
});

$('#openFilerId').click(function () {
  $(".trades-side").show();
  $(".trades-body").css("width", "79%");
});

const extractDate = (text) => {
  const parts = text.split('_');
  if (parts.length >= 3) {
    const months = {
      'JAN': 'JAN', 'FEB': 'FEB', 'MAR': 'MAR', 'APR': 'APR', 'MAY': 'MAY', 'JUN': 'JUN',
      'JUL': 'JUL', 'AUG': 'AUG', 'SEP': 'SEP', 'OCT': 'OCT', 'NOV': 'NOV', 'DEC': 'DEC'
    };

    const day = parts[2].substring(0, 2);
    const monthAbbreviation = parts[2].substring(2, 5);
    const year = parts[2].substring(5);

    const month = months[monthAbbreviation];
    if (!month) return '-'; // Invalid month abbreviation

    const formattedDate = `${day}-${month}-${year}`;
    return formattedDate;
  }
  return '-';
};

const miniList = [
  /ZINCMINI/,
  /SILVERM/,
  /NATGASMINI/,
  /LEADMINI/,
  /GOLDM/,
  /COPPERM/,
  /ALUMINIUM/,
  /CRUDEOILM/,
]
const apiCallForAllExchange = (exchange = "") => {
  $.ajax({
    type: "GET",
    url: `${BASE_URL}/api/tradeCoin?coinType=${exchange}`,
    success: function (data) {
      console.log(data); 
      $("#userScriptId").empty();
      data.response.map(item => {
        const expiryDate = extractDate(item.InstrumentIdentifier); // Extract date
        $("#userScriptId").append(`
          <tr>
            <td><input type="checkbox" /></td>
            <td>${miniList.find(itemFind => item.InstrumentIdentifier.match(itemFind)) ? "MINI" : item.Exchange}</td>
            <td>${item.InstrumentIdentifier}</td>
            <td>${expiryDate}</td>
            <td>${item.Exchange !== "NSE" ? item.InstrumentIdentifier.replaceAll("_", " ").slice(0, -1) : item.InstrumentIdentifier}</td>
            <td style="color:green;">Fully</td>
            <td>Yes</td>
          </tr>
        `);
      });
    },
    error: function (xhr, status, error) {
      console.error('Error:', error);
    }
  });
}

$("#serachBtnId").click(() => {
  apiCallForAllExchange($("#exchangeFilter").val())
})

apiCallForAllExchange();
</script>
{% endblock content %}

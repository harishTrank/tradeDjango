{% extends "index.html" %} {% block content %}
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<div class="tab-content" id="openposition">
    <div class="flex">
        <div class="trade-download">
            <div style="transform: rotate(90deg);padding-left: 10px;cursor:pointer;">
                <p id="openPositionFilterId">Filter</p>
            </div>
        </div>
        <div class="trades-side">
            <div class="trade-top">
                <div class="flex space-bw">
                    <div>
                        <p>Filter</p>
                    </div>
                    <div class="closeBtn">
                        <i class="fa-solid fa-xmark"></i>
                    </div>
                </div>
            </div>
            <div class="trade-btm">
                <div>
                    <label for="">Username:</label>
                    <select  id="userNameId">
                        <option value="">Select</option>
                        {% for obj in user_names %}
                          <option value="{{obj}}">{{obj}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="">Exchange:</label>
                    <select  id="exchangeSelectionId">
                        <option value="">Select</option>
                        {% for obj in exchange %}
                          <option value="{{obj}}">{{obj}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="">Symbol:</label>
                    <select  id="allSymbolID">
                        <option value="">Select</option>
                    </select>
                </div>
               
                <div>
                    <label for=""></label>
                    <input type="button" id="submitBtnHadlerId" value="View" class="form-btn">
                    <input type="submit" value="Clear" class="cancel-btn" onclick="clearbtnhref()">
                </div>
            </div>
        </div>
        <div class="trades-body user-table">
            <table style="width: 100%;">
                <tr>
                    <th>View</th>
                    {% comment %} <th>Parent User</th> {% endcomment %}
                    <th>Exchange</th>
                    <th>Symbol</th>
                    <th>Position</th>
                    <th>Quantity</th>
                    <th>Average Rate</th>
                    <th>CMP</th>
                    <th>Profit / Loss</th>
                </tr>
                <tbody id="openPositionLiveDataid">
           
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

  $('.closeBtn').click(function () {
    $(".trades-side").hide();
    $(".trades-body").css("width", "96%");
  });

  $('#openPositionFilterId').click(function () {
    $(".trades-side").show();
    $(".trades-body").css("width", "78%");
  });


  function clearbtnhref() {
    location.href = "{% url 'Admin:open-position' %}";
  }

        const baseNodeURL = BASE_URL
        const socket = io(baseNodeURL); 
        const dateManager = (val) => {
            return `${val?.split("_")?.[2]?.slice(0, 2)} ${val
              ?.split("_")?.[2]
              ?.slice(2, 5)} ${val?.split("_")?.[2]?.slice(7)}`;
          };
    
        
        const updateTotalPrice = (socketResponse, itemResult) => {
          return itemResult
            .map(item => {
              const findSocketVal = socketResponse.find(findObject =>
                  findObject?.InstrumentIdentifier === item?.identifer
              );
              return (
                item?.total_quantity > 0
                  ? (findSocketVal?.BuyPrice - item?.avg_buy_price) *
                    item?.total_quantity *
                    findSocketVal?.QuotationLot
                  : (item?.avg_sell_price - findSocketVal?.SellPrice) *
                    Math.abs(item?.total_quantity) *
                    findSocketVal?.QuotationLot
              ).toFixed(2);
            })
            .reduce((partialSum, a) => Number(partialSum) + Number(a), 0);
          };
        const profitLossHandler = (item, socketResponse) => {
            return (
              item?.total_quantity > 0
                ? (socketResponse?.BuyPrice - item?.avg_buy_price) *
                  item?.total_quantity *
                  socketResponse?.QuotationLot
                : (item?.avg_sell_price - socketResponse?.SellPrice) *
                  Math.abs(item?.total_quantity) *
                  socketResponse?.QuotationLot
                  ).toFixed(2);
        };

        const positionDataHandler = (exchange="", script="", user_name="{{request.user.user_name}}") => {
          $.ajax({
            type:'GET',
            url:`{% url "position" %}?user_name=${user_name}&exchange=${exchange}&script=${script}`,
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success:function(res){
              console.log("res", res)
              if (res.response.length > 0) {
                socket.connect();
                socket.on("connect", () => {
                  console.log("Connected to the Socket.io server");
                });
      
                socket.emit("filterDataGet", {identifier: res.response.map(item => item.identifer)});
      
                socket.on("filterDataSend", (data) => {
                  $("#totalPriceId").html(`P/L: ${updateTotalPrice(data, res.response).toFixed(2)}`);
                  $("#openPositionLiveDataid").empty();
                  if (data.length > 0) {
                    data?.map(item => {
                      const current_data = res?.response?.find(findItem => findItem.identifer === item.InstrumentIdentifier)
                      const profitLossValue = profitLossHandler(current_data, item);
                      $("#openPositionLiveDataid").append(`
                        <tr>
                          <td onClick="openpositionhandler()">
                            <span style="padding: 1px;" class="material-symbols-outlined">
                                density_small
                            </span> 
                          </td>
                          <td>${item?.Exchange}</td>
                          <td>${current_data?.coin_name}</td>
                          <td style="color: ${current_data?.total_quantity < 0 ? 'red' : 'blue'};">${current_data?.total_quantity > 0 ? "BUY" : "SELL"}</td>
                          <td style="color: ${current_data?.total_quantity < 0 ? 'red' : 'blue'};">${Math.abs(current_data?.total_quantity)}</td>
                          <td>${current_data?.total_quantity > 0 ? Math.round(current_data?.avg_buy_price * 100) / 100 : Math.round(current_data?.avg_sell_price * 100) / 100}</td>
                          <td>${current_data?.total_quantity > 0 ? item?.BuyPrice : item?.SellPrice}</td>
                          ${profitLossValue && profitLossValue > 0 ? `<td style="color: blue">${profitLossValue}</td>` : `<td style="color: red">${Math.abs(profitLossValue)}</td>`}
                        </tr>
                      `)
                    })
                  }
                });
      
                socket.on("disconnect", () => {
                    console.log("Disconnected from the Socket.io server");
                });
              } else {
                $("#openPositionLiveDataid").empty();
                socket.disconnect();
              }
            },
            error:function(err){
              alert(err?.responseJSON.message);
            }
          })
        }

        positionDataHandler();

        $("#submitBtnHadlerId").click(() => {
          positionDataHandler($("#exchangeSelectionId").val(),$("#allSymbolID").val(), $("#userNameId").val());
        })
    
        $("#scriptNameId").change((event) => {
            socket.on("connect", () => {
                console.log("Connected to the Socket.io server");
            });
              socket.emit("getOneData", { "identifier": event.target.value });
              socket.on("getOneDataSend", (data) => {
                  if (data?.InstrumentIdentifier === event.target.value) {
                      $("#buyPriceID").val(data.BuyPrice);
                      $("#sellPriceID").val(data.SellPrice);
                      $("#currentCoinDataId").val(JSON.stringify(data));
                  }
              }); 
            socket.on("disconnect", () => {
                console.log("Disconnected from the Socket.io server");
            });
        });

        const symbolsHandler = (exhange="") => {
          axios.get(`{% url 'user-coin-list' %}?exchange=${exhange}`).then(res => {
            $("#allSymbolID").empty();
            $("#allSymbolID").append(`<option value="">Select</option>`);
            res?.data?.response?.map(pussy => {
              $("#allSymbolID").append(`<option value="${pussy.coin_name}">${pussy.coin_name}</option>`)
            })
          })
        }
        symbolsHandler();

        $("#exchangeSelectionId").change((event) => {
          symbolsHandler(event.target.value)
        })


        const openpositionhandler = () => {
          var left = (screen.width/2)-(1000/2);
          var top = (screen.height/2)-(500/2);
          window.open(`open-position-view`, 'NewWindow1', `width=1000,height=500,left=${left},top=${top}`);
      }
</script>

{% endblock content %}
